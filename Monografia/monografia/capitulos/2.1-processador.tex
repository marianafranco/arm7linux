% O Processador ARM7
\section{O Processador ARM7TDMI} \label{sec:conceitos_processador}
\index{conceitos!processador} 

O ARM7TDMI faz parte da família de processadores ARM7 32 bits conhecida por oferecer bom desempenho aliado a um baixo consumo de energia. Essas características fazem com que o ARM7TDMI seja bastante utilizado em media players, vídeo games e, principalmente, em sistemas embarcados e num grande número de aparelhos celulares.

%-------------------------------------------
% Arquitetura RISC
%-------------------------------------------
\subsection{Arquitetura RISC} \label{sub:risc}
\index{conceitos!processador!risc}

Os processadores ARM, incluindo o ARM7TDMI, foram projetados com a arquitetura RISC.

RISC (Reduced Instruction Set Computer) é uma arquitetura de computadores baseada em um conjunto simples e pequeno de instruções capazes de serem executadas em um único ou poucos ciclos de relógio.
 
A idéia por trás da arquitetura RISC é de reduzir a complexidade das instruções executadas pelo hardware e deixar as tarefas mais complexas para o software. Como resultado, o RISC demanda mais do compilador do que os tradicionais computadores CISC (Complex Instruction Set Computer) que, por sua vez, dependem mais do processador já que suas instruções são mais complicadas.

As principais características da arquitetura RISC são:

\begin{enumerate}

\item Conjunto reduzido e simples de instruções capazes de serem executadas em único ciclo de máquina.

\item Uso de pipeline, ou seja, o processamento das instruções é quebrado em pequenas unidades que podem ser executadas em paralelo.

\item Presença de um conjunto de registradores.

\item Arquitetura Load-Store: o processador opera somente sobre os dados contidos nos registradores e instruções de load/store transferem dados entre a memória e os registradores.

\item Modos simples de endereçamento à memória.

\end{enumerate}

%-------------------------------------------
% Pipeline
%-------------------------------------------
\subsection{Pipeline} \label{sub:pipeline}
\index{conceitos!processador!pipeline}

A arquitetura de pipeline aumenta a velocidade do fluxo de instruções para o processador, pois permite que várias operações ocorram simultaneamente, fazendo o processador e a memória operarem continuamente. 

O ARM7 possui uma arquitetura de pipeline de três estágios. Durante operação normal, o processador estará sempre ocupado em executar três instruções em diferentes estágios. Enquanto executa a primeira, decodifica a segunda e busca a terceira.

\begin{figure}[ht]
	\begin{center}
		\includegraphics[scale=0.25]{figuras/pipeline.pdf}
		\caption{Pipeline de 3 estágios\label{fig:pipeline}}
	\end{center}
\end{figure}

O primeiro estágio de pipeline lê a instrução da memória e incrementa o valor do registrador de endereços, que guarda o valor da próxima instrução a ser buscada. O próximo estágio decodifica a instrução e prepara os sinais de controle necessários para executá-la.  O terceiro lê os operandos do banco de registradores, executa as operações através da ALU (Arithmetic Logic Unit), lê ou escreve na memória, se necessário, e guarda o resultado das instruções no banco de registradores.

\paragraph{} % linha em branco
\paragraph{}

\begin{figure}[ht]
	\begin{center}
		\includegraphics[scale=0.75]{figuras/pipeline_blockdiagram.jpg}
		\caption{Pipeline do ARM7TDMI\label{fig:pipeline_blockdiagram}}
	\end{center}
\end{figure}


Algumas características importantes do pipeline do ARM7:

\begin{itemize}

\item O Program Counter (PC) ao invés de apontar para a instrução que esta sendo executada, aponta para a instrução que esta sendo buscada na memória.

\item O processador só processa a instrução quando essa passa completamente pelo estágio execute. Ou seja, somente quando a quarta instrução é buscada (fetched).

\item A execução de uma instrução de branch através da modificação do PC provoca a descarga de todas as outras instruções do pipeline.

\item Uma instrução no estágio execute será completada mesmo se acontecer uma interrupção. As outras instruções no pipeline serão abandonadas e o processador começará a encher o pipeline a partir da entrada apropriada no vetor de interrupção.

\end{itemize}



%-------------------------------------------
% Estados de Operação
%-------------------------------------------
\subsection{Estados de Operação} \label{sub:estados}
\index{conceitos!processador!estados}

O processador ARM7TDMI possui dois estados de operação:

\begin{itemize}
\item ARM: modo normal, onde o processador executa instruções de 32 bits (cada instrução corresponde a uma palavra);
\item Thumb: modo especial, onde o processador executa instruções de 16 bits que correspondem à meia palavra.
\end{itemize}

Instruções Thumbs são um conjunto de instruções de 16 bits equivalentes as instruções 32 bits ARM. A vantagem em tal esquema, é que a densidade de código aumenta, já que o espaço necessário para um mesmo número de instruções é menor. Em compensação, nem todas as instruções ARM tem um equivalente Thumb.

Neste projeto, decidimos pela utilização do processador no modo ARM que facilita o desenvolvimento por possuir um número maior de instruções.


%-------------------------------------------
% Modos de Operação
%-------------------------------------------
\subsection{Modos de Operação} \label{sub:modo}
\index{conceitos!processador!modos}

Os processadores ARM possuem 7 modos de operação:

\begin{center}
\begin{table}[ht]
\begin{tabular}{|l|l|p{7.5cm}|}
\hline
		\textbf{Modo}	&	\textbf{Identificador}	& \textbf{Descrição}	\\
\hline
		Usuário			&	usr			& 	Execução normal de programas.	\\
\hline
		FIQ(Fast Interrupt)	&	fiq		&	Tratamento de interrupções rápidas. \\
\hline
		IRQ (Interrupt)	&	irq			&	Tratamento de interrupções comuns.	\\
\hline
		Supervisor		&	svc			&	Modo protegido para o sistema operacional.	\\
\hline
		Abort			&	abt			&	Usado para implementar memória virtual ou manipular violações na memória.	\\
\hline
		Sistema			&	sys			&	Executa rotinas privilegiadas do sistema operacional.	\\
\hline
		Indefinido		&	und			&	Modo usado quando uma instrução desconhecida é executada.	\\
\hline
\end{tabular}
\caption{Modos de operação\label{modos}}
\end{table}
\end{center}

Mudanças no modo de operação podem ser feitas através de programas, ou podem ser causadas por interrupções externas ou exceções (interrupções de software).

A maioria dos programas roda no modo Usuário. Quando o processador esta no modo Usuário, o programa que esta sendo executado não pode acessar alguns recursos protegidos do sistema ou mudar de modo sem ser através de uma interrupção.

Os outros modos são conhecidos como modos privilegiados. Eles têm total acesso aos recursos do sistema e podem mudar livremente de modo de operação. Cinco desses modos são conhecidos como modos de interrupção: FIQ, IRQ, Supervisor, Abort e Indefinido.

Entra-se nesses modos quando uma interrupção ocorre. Cada um deles possui registradores adicionais que permitem salvar o modo Usuário quando uma interrupção ocorre.

O modo remanescente é o modo Sistema, que não é acessível por interrupção e usa os mesmos registradores disponíveis para o modo Usuário. No entanto, este é um modo privilegiado e, assim, não possui as restrições do modo Usuário.  Este modo destina-se as operações que necessitam de acesso aos recursos do sistema, mas que querem evitar o uso adicional dos registradores associados aos modos de interrupção.



%-------------------------------------------
% Registradores
%-------------------------------------------
\subsection{Registradores} \label{sub:registradores}
\index{conceitos!processador!registradores}

O processador ARM7TDMI tem um total de 37 registradores:

\begin{itemize}
\item 31 registradores de 32 bits de uso geral
\item 6 registradores de estado
\end{itemize}

Esses registradores não são todos acessíveis ao mesmo tempo. O modo de operação do processador determina quais registradores são disponíveis ao programador.

\subsubsection{Modo Usuário e Sistema}

O conjunto de registradores para o modo Usuário (o mesmo usado no modo Sistema) contém 16 registradores diretamente acessíveis, R0 à R15. Um adicional registrador, o CPSR (Current Program Status Register), contem os bits de flag e de modo. 

Os registradores R13 à R15 possuem as seguintes funções especiais: 

\begin{itemize}
\item R13: usado como ponteiro de pilha, stack pointer (SP)
\item R14: é chamado de link register (lr) e é onde se coloca o endereço de retorno sempre que uma sub-rotina é chamada.
\item R15: corresponde ao program counter (pc) e contém o endereço da próxima instrução à ser executada pelo processador.
\end{itemize}

\subsubsection{Modos privilegiados}

Além dos registradores acessíveis ao programador, o ARM coloca à disposição mais alguns registradores nos modos privilegiados. Esses registradores são mapeados aos registradores acessíveis ao programador no modo Usuário e permitem que estes sejam salvos a cada interrupção.

\begin{figure}[ht]
	\begin{center}
		\includegraphics[scale=0.65]{figuras/registradores.jpg}
		\caption{Organização dos registradores no modo ARM\label{fig:registradores}}
	\end{center}
\end{figure}

Como se pode verificar na figura, cada modo tem o seu próprio R13 e R14. Isso permite que cada modo mantenha seu próprio ponteiro de pilha (SP) e endereço de retorno (LR).

Além desses dois registradores, o modo FIQ possui mais cinco registradores especiais: R8\textunderscore fiq-R12\textunderscore fiq. Isso significa que quando o processador muda para o modo FIQ, o programa não precisa salvar os registradores R8-R12.

Esses registradores especiais mapeiam de um pra um os registradores do modo usuário. Se você mudar o modo do processador, um registrador particular do novo modo irá substituir o registrador existente.

Por exemplo, quando o processador esta no modo IRQ, as instruções executadas continuarão a acessar os registradores R13 e R14. No entanto, esses serão os registradores especiais R13\textunderscore irq e R14\textunderscore irq. Os registradores do modo usuário (R13\textunderscore usr e R14\textunderscore usr) não serão afetados pelas instruções referenciando esses registradores. O programa continua tendo acesso normal aos outros registradores R0 à R12.


%-------------------------------------------
% Registradores de Estado
%-------------------------------------------
\subsection{Registradores de Estado} \label{sub:reg_estado}
\index{conceitos!processador!reg_estado}

O Current Program Status Register (CPRS) é acessível em todos os modos do processador. Ele contém as flags de condição, os bits para desabilitar as interrupções, o modo atual do processador, e outras informações de estado e controle. Cada modo de exceção possui também um Saved Program Register (SPRS), que é usado para preservar o valor do CPSR quando a exceção associada acontece. 

Os registradores de estado do programa:

\begin{itemize}
\item Guardam informação sobre a operação mais recente executada pela ULA (ALU).
\item Controlam o ativar e desativar de interrupções.
\item Determinam o modo de operação do processador.
\end{itemize}

\paragraph{} % linha em branco
\paragraph{}
\paragraph{}

\begin{figure}[ht]
	\begin{center}
		\includegraphics[scale=0.65]{figuras/status_register.jpg}
		\caption{Formato dos registradores de estado CPSR e SPSR\label{fig:status_register}}
	\end{center}
\end{figure}

\subsubsection{Flags de Condição}

Os bits N, Z, C e V são flags de condição, é possível de alterá-los através do resultado de operações lógicas ou aritméticas. 

Os flags de condição são normalmente modificados por:

\begin{itemize}
\item Uma instrução de comparação (CMN, CMP, TEQ, TST).
\item Alguma outra instrução aritmética, lógica ou move, onde o registrador de destino não é o R15 (PC).
\end{itemize}

Nesses dois casos, as novas flags de condição (depois de a instrução ter sido executada) normalmente significam:

\begin{itemize}
\item N: Indica se o resultado da instrução é um número positivo (N=0) ou negativo (N=1).
\item Z: Contém 1 se o resultado da instrução é zero (isso normalmente indica um resultado de igualdade para uma comparação), e 0 se o contrário.
\item C: Pode possuir significados diferentes:
	\begin{itemize}
	\item Para uma adição, C contém 1 se a adição produz "vai-um" (carry), e 0 caso contrário.
	\item Para uma subtração, C contém 0 se a subtração produz "vem-um" (borrow), e 1 caso contrário.
	\item Para as instruções que incorporam deslocamento, C contém o último bit deslocado para fora pelo deslocador.
	\item Para outras instruções, C normalmente não é usado.
	\end{itemize}
\item V: Possui dois significados:
	\begin{itemize}
	\item Para adição ou subtração, V contém 1 caso tenha ocorrido um overflow considerando os operandos e o resultado em complemento de dois.
	\item o	Para outras instruções, V normalmente não é usado.
	\end{itemize}
\end{itemize}

\subsubsection{Bits de Controle}

Os oito primeiros bits de um PSR (Program Status Register) são conhecidos como bits de controle. Eles são:

\begin{itemize}
\item Bits de desativação de interrupção
\item Bit T
\item Bits de modo
\end{itemize}

Os bits de controle mudam quando uma interrupção acontece. Quando o processador esta operando em um modo privilegiado, programas podem manipular esses bits.

\paragraph{Bits de desativação de interrupção}
\paragraph{}

Os bits I e F são bits de desativação de interrupção:

\begin{itemize}
\item Quando o bit I é ativado, as interrupções IRQ são desativadas.
\item Quando o bit F é ativado, as interrupções FIQ são desativadas.
\end{itemize}


\paragraph{Bit T}
\paragraph{}

O bit T reflete o modo de operação:

\begin{itemize}
\item Quando o bit T é ativado, o processador é executado em estado Thumb.
\item Quando o bit T é limpo, o processador é executado em estado ARM.
\end{itemize}


\paragraph{Bits de modo}
\paragraph{}

Os bits M[4:0] determinam o modo de operação. Nem todas as combinações dos bits de modo definem um modo válido, portando tome cuidado para usar somente as combinações mostradas a seguir:

\begin{center}
\begin{table}[ht]
\begin{tabular}{|l|l|p{7.5cm}|}
\hline
		\textbf{Bit de modo}	&	\textbf{Modo de operação}	& \textbf{Registradores acessíveis}	\\
\hline
		10000	&	Usuário(usr)	& 	PC,R14-R0,CPSR	\\
\hline
		10001	&	FIQ(fiq)		&	PC,R14\textunderscore fiq-R8\textunderscore fiq,R7-R0,CPSR,SPSR\textunderscore fiq		\\
\hline
		10010	&	IRQ(irq)		&	PC,R14\textunderscore irq, R13\textunderscore irq,R12-R0,CPSR,SPSR\textunderscore irq	\\
\hline
		10011	&	Supervisor(svc)	&	PC,R14\textunderscore svc,	R13\textunderscore irq,R12-R0,CPSR,SPSR\textunderscore svc \\
\hline
		10111	&	Abort(abt)		&	PC,R14\textunderscore abt,	R13\textunderscore irq,R12-R0,CPSR,SPSR\textunderscore abt	\\
\hline
		11011	&	Indefinido(und)	&	PC,R14\textunderscore und,	R13\textunderscore irq,R12-R0,CPSR,SPSR\textunderscore und \\
\hline
		11111	&	Sistema(sys)	&	PC,R14-R0,CPRS	\\
\hline
\end{tabular}
\caption{Valores para o bit de modo \label{bit_tipo}}
\end {table}
\end{center}

%-------------------------------------------
% Interrupções
%-------------------------------------------
\subsection{Interrupções} \label{sub:interrupcoes}
\index{conceitos!processador!interrupcoes}

Interrupções surgem sempre que o fluxo normal de um programa deve ser interrompido temporariamente, por exemplo, para servir uma interrupção vinda de um periférico ou a tentativa de executar uma instrução desconhecida. Antes de tentar lidar com uma interrupção, o ARM7TDMI preserva o estado atual de forma que o programa original possa ser retomado quando a rotina de interrupção tiver acabado. 

A arquitetura ARM suporta 7 tipos de interrupções. A figura a baixo lista os tipos de interrupção e o modo do processador usado para lidar com cada tipo. Quando uma interrupção acontece, a execução é forçada para um endereço fixo de memória correspondente ao tipo de interrupção. Esses endereços fixos são chamados de vetores de interrupção.

\begin{center}
\begin{table}[ht]
\begin{tabular}{|l|l|p{7.5cm}|}
\hline
		\textbf{Tipo de interrupção}	&	\textbf{Modo de operação}	& \textbf{Endereço}	\\
\hline
		Reset							&	Supervisor	& 	0x00000000	\\
\hline
		Instrução indefinida			&	Indefinido	&	0x00000000 	\\
\hline
		Interrupção de Software (swi)	&	Supervisor	&	0x00000000	\\
\hline
		10011							&	Abort		&	0x00000000 \\
\hline
		10111							&	Abort		&	0x00000000	\\
\hline
		Interrupção normal(IRQ)			&	IRQ			&	0x00000000 \\
\hline
		Interrupção rápida(FIQ)			&	FIQ			&	0x00000000	\\
\hline
\end{tabular}
\caption{Valores para o bit de modo \label{bit_tipo}}
\end {table}
\end{center}

Deve-se notar olhando para a tabela a cima, que existe espaço suficiente para apenas uma instrução entre cada vetor de interrupção (4 bytes). Estes são inicializados com instruções de desvio (branch).

