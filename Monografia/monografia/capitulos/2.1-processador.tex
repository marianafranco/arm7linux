% O Processador ARM7
\section{O Processador ARM7TDMI} \label{sec:conceitos_processador}
\index{conceitos!processador} 

O ARM7TDMI faz parte da família de processadores ARM7 32 bits conhecida por oferecer bom desempenho aliado a um baixo consumo de energia. Essas características fazem com que o ARM7TDMI seja bastante utilizado em media players, vídeo games e, principalmente, em sistemas embarcados e num grande número de aparelhos celulares \cite{Sloss2004}.



%-------------------------------------------
% Arquitetura RISC
%-------------------------------------------
\subsection{Arquitetura RISC} \label{sub:risc}
\index{conceitos!processador!risc}

Os processadores ARM, incluindo o ARM7TDMI, foram projetados com a arquitetura RISC.

RISC (\emph{Reduced Instruction Set Computer}) é uma arquitetura de computadores baseada em um conjunto simples e pequeno de instruções capazes de serem executadas em um único ou poucos ciclos de relógio.
 
A idéia por trás da arquitetura RISC é de reduzir a complexidade das instruções executadas pelo \emph{hardware} e deixar as tarefas mais complexas para o \emph{software}. Como resultado, o RISC demanda mais do compilador do que os tradicionais computadores CISC (\emph{Complex Instruction Set Computer}) que, por sua vez, dependem mais do processador já que suas instruções são mais complicadas \cite{Sloss2004}.

As principais características da arquitetura RISC são:

\begin{enumerate}

\item Conjunto reduzido e simples de instruções capazes de serem executadas em único ciclo de máquina.

\item Uso de \emph{pipeline}, ou seja, o processamento das instruções é quebrado em pequenas unidades que podem ser executadas em paralelo.

\item Presença de um conjunto de registradores.

\item Arquitetura \emph{Load-Store}: o processador opera somente sobre os dados contidos nos registradores e instruções de \emph{load}/\emph{store} transferem dados entre a memória e os registradores.

\item Modos simples de endereçamento à memória.

\end{enumerate}



%-------------------------------------------
% Pipeline
%-------------------------------------------
\subsection{Pipeline} \label{sub:pipeline}
\index{conceitos!processador!pipeline}

A arquitetura de \emph{pipeline} aumenta a velocidade do fluxo de instruções para o processador, pois permite que várias operações ocorram simultaneamente, fazendo o processador e a memória operarem continuamente \cite{TechManual}. 

O ARM7 possui uma arquitetura de \emph{pipeline} de três estágios. Durante operação normal, o processador estará sempre ocupado em executar três instruções em diferentes estágios. Enquanto executa a primeira, decodifica a segunda e busca a terceira.

\begin{figure}[ht]
	\begin{center}
		\includegraphics[scale=0.40]{figuras/pipeline.png}
		\caption{\emph{Pipeline} de 3 estágios \cite{TechManual}}
		\label{fig:pipeline}
	\end{center}
\end{figure}

O primeiro estágio de \emph{pipeline} lê a instrução da memória e incrementa o valor do registrador de endereços, que guarda o valor da próxima instrução a ser buscada. O próximo estágio decodifica a instrução e prepara os sinais de controle necessários para executá-la.  O terceiro lê os operandos do banco de registradores, executa as operações através da ALU (\emph{Arithmetic Logic Unit}), lê ou escreve na memória, se necessário, e guarda o resultado das instruções no banco de registradores.


\begin{figure}[ht]
	\begin{center}
		\includegraphics[scale=0.15]{figuras/pipeline_blockdiagram.png}
		\caption{\emph{Pipeline} do ARM7TDMI \cite{Ryzhyk2006}}
		\label{fig:pipeline_blockdiagram}
	\end{center}
\end{figure}


Algumas características importantes do \emph{pipeline} do ARM7:

\begin{itemize}

\item O \emph{Program Counter} (PC) ao invés de apontar para a instrução que esta sendo executada, aponta para a instrução que esta sendo buscada na memória.

\item O processador só processa a instrução quando essa passa completamente pelo estágio de execução (\emph{execute}). Ou seja, somente quando a quarta instrução é buscada (\emph{fetched}).

\item A execução de uma instrução de \emph{branch} através da modificação do PC provoca a descarga de todas as outras instruções do \emph{pipeline}.

\item Uma instrução no estágio \emph{execute} será completada mesmo se acontecer uma interrupção. As outras instruções no \emph{pipeline} serão abandonadas e o processador começará a encher o \emph{pipeline} a partir da entrada apropriada no vetor de interrupção.

\end{itemize}



%-------------------------------------------
% Estados de Operação
%-------------------------------------------
\subsection{Estados de Operação} \label{sub:estados}
\index{conceitos!processador!estados}

O processador ARM7TDMI possui dois estados de operação \cite{TechManual}:

\begin{itemize}
\item ARM: modo normal, onde o processador executa instruções de 32 bits (cada instrução corresponde a uma palavra);
\item Thumb: modo especial, onde o processador executa instruções de 16 bits que correspondem à meia palavra.
\end{itemize}

Instruções Thumbs são um conjunto de instruções de 16 bits equivalentes as instruções 32 bits ARM. A vantagem em tal esquema, é que a densidade de código aumenta, já que o espaço necessário para um mesmo número de instruções é menor. Em compensação, nem todas as instruções ARM tem um equivalente Thumb.

Neste projeto, o processador é usado no modo ARM que facilita o desenvolvimento por possuir um número maior de instruções.



%-------------------------------------------
% Modos de Operação
%-------------------------------------------
\subsection{Modos de Operação} \label{sub:modo}
\index{conceitos!processador!modos}

Os processadores ARM possuem 7 modos de operação:


\begin{table}[ht]
\begin{center}
\begin{tabular}{|l|l|p{7.5cm}|}
\hline
		\textbf{Modo}	&	\textbf{Identificador}	& \textbf{Descrição}	\\
\hline
		Usuário			&	usr			& 	Execução normal de programas.	\\
\hline
		FIQ(\emph{Fast Interrupt})	&	fiq		&	Tratamento de interrupções rápidas. \\
\hline
		IRQ (\emph{Interrupt})	&	irq			&	Tratamento de interrupções comuns.	\\
\hline
		Supervisor		&	svc			&	Modo protegido para o sistema operacional.	\\
\hline
		\emph{Abort}			&	abt			&	Usado para implementar memória virtual ou manipular violações na memória.	\\
\hline
		Sistema			&	sys			&	Executa rotinas privilegiadas do sistema operacional.	\\
\hline
		Indefinido		&	und			&	Modo usado quando uma instrução desconhecida é executada.	\\
\hline
\end{tabular}
\caption{Modos de operação \cite{ArchManual} \label{modos}}
\end{center}
\end{table}


Mudanças no modo de operação podem ser feitas através de programas, ou podem ser causadas por interrupções externas ou exceções (interrupções de software).

A maioria dos programas roda no modo Usuário. Quando o processador esta no modo Usuário, o programa que esta sendo executado não pode acessar alguns recursos protegidos do sistema ou mudar de modo sem ser através de uma interrupção \cite{ArchManual}.

Os outros modos são conhecidos como modos privilegiados. Eles têm total acesso aos recursos do sistema e podem mudar livremente de modo de operação. Cinco desses modos são conhecidos como modos de interrupção: FIQ, IRQ, Supervisor, \emph{Abort} e Indefinido.

Entra-se nesses modos quando uma interrupção ocorre. Cada um deles possui registradores adicionais que permitem salvar o modo Usuário quando uma interrupção ocorre.

O modo remanescente é o modo Sistema, que não é acessível por interrupção e usa os mesmos registradores disponíveis para o modo Usuário. No entanto, este é um modo privilegiado e, assim, não possui as restrições do modo Usuário.  Este modo destina-se as operações que necessitam de acesso aos recursos do sistema, mas querem evitar o uso adicional dos registradores associados aos modos de interrupção.



%-------------------------------------------
% Registradores
%-------------------------------------------
\subsection{Registradores} \label{sub:registradores}
\index{conceitos!processador!registradores}

O processador ARM7TDMI tem um total de 37 registradores:

\begin{itemize}
\item 31 registradores de 32 bits de uso geral
\item 6 registradores de estado
\end{itemize}

Esses registradores não são todos acessíveis ao mesmo tempo. O modo de operação do processador determina quais registradores são disponíveis ao programador \cite{TechManual}.

\subsubsection{Modo Usuário e Sistema}

O conjunto de registradores para o modo Usuário (o mesmo usado no modo Sistema) contém 16 registradores diretamente acessíveis, R0 à R15. Um registrador adicional, o CPSR (\emph{Current Program Status Register}), contém os bits de \emph{flag} e de modo. 

Os registradores R13 à R15 possuem as seguintes funções especiais \cite{Sloss2004}: 

\begin{itemize}
\item R13: usado como ponteiro de pilha, \emph{Stack Pointer} (SP)
\item R14: é chamado de \emph{Link Register} (LR) e é onde se coloca o endereço de retorno sempre que uma sub-rotina é chamada.
\item R15: corresponde ao \emph{Program Counter} (PC) e contém o endereço da próxima instrução à ser executada pelo processador.
\end{itemize}

\subsubsection{Modos privilegiados}

Além dos registradores acessíveis ao programador, o ARM coloca à disposição mais alguns registradores nos modos privilegiados. Esses registradores são mapeados aos registradores acessíveis ao programador no modo Usuário e permitem que estes sejam salvos a cada interrupção.

\begin{figure}[ht]
	\begin{center}
		\includegraphics[scale=0.08]{figuras/registradores.png}
		\caption{Organização dos registradores no modo ARM \cite{TechManual}}
		\label{fig:registradores}
	\end{center}
\end{figure}

Como se pode verificar na figura \ref{fig:registradores}, cada modo tem o seu próprio R13 e R14. Isso permite que cada modo mantenha seu próprio ponteiro de pilha (SP) e endereço de retorno (LR) \cite{Zaitseff2003}.

Além desses dois registradores, o modo FIQ possui mais cinco registradores especiais: R8\textunderscore fiq-R12\textunderscore fiq. Isso significa que quando o processador muda para o modo FIQ, o programa não precisa salvar os registradores R8-R12.

Esses registradores especiais mapeiam de um pra um os registradores do modo usuário. Se você mudar o modo do processador, um registrador particular do novo modo irá substituir o registrador existente.

Por exemplo, quando o processador esta no modo IRQ, as instruções executadas continuarão a acessar os registradores R13 e R14. No entanto, esses serão os registradores especiais R13\textunderscore irq e R14\textunderscore irq. Os registradores do modo usuário (R13\textunderscore usr e R14\textunderscore usr) não serão afetados pelas instruções referenciando esses registradores. O programa continua tendo acesso normal aos outros registradores R0 à R12 \cite{Sloss2004}.



%-------------------------------------------
% Registradores de Estado
%-------------------------------------------
\subsection{Registradores de Estado} \label{sub:reg_estado}
\index{conceitos!processador!reg_estado}

O \emph{Current Program Status Register} (CPRS) é acessível em todos os modos do processador. Ele contém as \emph{flags} de condição, os bits para desabilitar as interrupções, o modo atual do processador, e outras informações de estado e controle. Cada modo de interrupção possui também um \emph{Saved Program Register} (SPRS), que é usado para preservar o valor do CPSR quando a interrupção associada acontece \cite{ArchManual}.

Os registradores de estado do programa \cite{TechManual}:

\begin{itemize}
\item Guardam informação sobre a operação mais recente executada pela ALU.
\item Controlam o ativar e desativar de interrupções.
\item Determinam o modo de operação do processador.
\end{itemize}

Como mostrado na figura \ref{fig:status_register} o CPSR é dividido em 3 campos: \emph{flag}, reservado (não utilizado) e controle.

O campo de controle guarda os bits de modo, estado e de interrupção, enquanto o campo \emph{flag} armazena os bits de condição.

\begin{figure}[ht]
	\begin{center}
		\includegraphics[scale=0.10]{figuras/status_register.png}
		\caption{Formato dos registradores de estado CPSR e SPSR \cite{TechManual}}
		\label{fig:status_register}
	\end{center}
\end{figure}


\subsubsection{Flags de Condição}

Os bits N, Z, C e V são \emph{flags} de condição, e é possível alterá-los através do resultado de operações lógicas ou aritméticas \cite{ArchManual}. 

Os \emph{flags} de condição são normalmente modificados por:

\begin{itemize}
\item Uma instrução de comparação (CMN, CMP, TEQ, TST).
\item Alguma outra instrução aritmética, lógica ou move, onde o registrador de destino não é o R15 (PC).
\end{itemize}

Nesses dois casos, as novas \emph{flags} de condição (depois de a instrução ter sido executada) normalmente significam:

\begin{itemize}
\item N: Indica se o resultado da instrução é um número positivo (N=0) ou negativo (N=1).
\item Z: Contém 1 se o resultado da instrução é zero (isso normalmente indica um resultado de igualdade para uma comparação), e 0 se o contrário.
\item C: Pode possuir significados diferentes:
	\begin{itemize}
	\item Para uma adição, C contém 1 se a adição produz "vai-um" (\emph{carry}), e 0 caso contrário.
	\item Para uma subtração, C contém 0 se a subtração produz "vem-um" (\emph{borrow}), e 1 caso contrário.
	\item Para as instruções que incorporam deslocamento, C contém o último bit deslocado para fora pelo deslocador.
	\item Para outras instruções, C normalmente não é usado.
	\end{itemize}
\item V: Possui dois significados:
	\begin{itemize}
	\item Para adição ou subtração, V contém 1 caso tenha ocorrido um \emph{overflow} considerando os operandos e o resultado em complemento de dois.
	\item Para outras instruções, V normalmente não é usado.
	\end{itemize}
\end{itemize}

\subsubsection{Bits de Controle}

Os oito primeiros bits de um PSR (\emph{Program Status Register}) são conhecidos como bits de controle \cite{ArchManual}. Eles são:

\begin{itemize}
\item Bits de desativação de interrupção
\item Bit T
\item Bits de modo
\end{itemize}

Os bits de controle mudam quando uma interrupção acontece. Quando o processador esta operando em um modo privilegiado, programas podem manipular esses bits.

\paragraph{Bits de desativação de interrupção}
\paragraph{}

Os bits I e F são bits de desativação de interrupção:

\begin{itemize}
\item Quando o bit I é ativado, as interrupções IRQ são desativadas.
\item Quando o bit F é ativado, as interrupções FIQ são desativadas.
\end{itemize}


\paragraph{Bit T}
\paragraph{}

O bit T reflete o modo de operação:

\begin{itemize}
\item Quando o bit T é ativado, o processador é executado em estado Thumb.
\item Quando o bit T é limpo, o processador é executado em estado ARM.
\end{itemize}


\paragraph{Bits de modo}
\paragraph{}

Os bits M[4:0] determinam o modo de operação. Nem todas as combinações dos bits de modo definem um modo válido, portando deve-se tomar cuidado para usar somente as combinações mostradas a seguir:


\begin{table}[ht]
\begin{center}
\begin{tabular}{|l|l|p{8.5cm}|}
\hline
		\textbf{Bit de modo}	&	\textbf{Modo de operação}	& \textbf{Registradores acessíveis}	\\
\hline
		10000	&	Usuário(usr)	& 	PC,R14-R0,CPSR	\\
\hline
		10001	&	FIQ(fiq)		&	PC,R14\textunderscore fiq-R8\textunderscore fiq,R7-R0,CPSR,SPSR\textunderscore fiq		\\
\hline
		10010	&	IRQ(irq)		&	PC,R14\textunderscore irq, R13\textunderscore irq,R12-R0,CPSR,SPSR\textunderscore irq	\\
\hline
		10011	&	Supervisor(svc)	&	PC,R14\textunderscore svc,	R13\textunderscore irq,R12-R0,CPSR,SPSR\textunderscore svc \\
\hline
		10111	&	\emph{Abort}(abt)		&	PC,R14\textunderscore abt,	R13\textunderscore irq,R12-R0,CPSR,SPSR\textunderscore abt	\\
\hline
		11011	&	Indefinido(und)	&	PC,R14\textunderscore und,	R13\textunderscore irq,R12-R0,CPSR,SPSR\textunderscore und \\
\hline
		11111	&	Sistema(sys)	&	PC,R14-R0,CPRS	\\
\hline
\end{tabular}
\caption{Valores para o bit de modo \cite{ArchManual}}
\label{bit_tipo}
\end{center}
\end {table}



%-------------------------------------------
% Interrupções
%-------------------------------------------
\subsection{Interrupções} \label{sub:interrupcoes}
\index{conceitos!processador!interrupcoes}

Interrupções surgem sempre que o fluxo normal de um programa deve ser interrompido temporariamente, por exemplo, para servir uma interrupção vinda de um periférico ou a tentativa de executar uma instrução desconhecida. Antes de tentar lidar com uma interrupção, o ARM7TDMI preserva o estado atual de forma que o programa original possa ser retomado quando a rotina de interrupção tiver acabado \cite{TechManual}. 

A arquitetura ARM suporta 7 tipos de interrupções. A tabela \ref{table:interrupt_vector} lista os tipos de interrupção e o modo do processador usado para lidar com cada tipo. Quando uma interrupção acontece, a execução é forçada para um endereço fixo de memória correspondente ao tipo de interrupção. Esses endereços fixos são chamados de vetores de interrupção \cite{ArchManual}.


\begin{table}[ht]
\begin{center}
\begin{tabular}{|l|l|l|}
\hline
		\textbf{Tipo de interrupção}	&	\textbf{Modo de operação}	& \textbf{Endereço}	\\
\hline
		\emph{Reset}							&	Supervisor	& 	0x00000000	\\
\hline
		Instrução indefinida			&	Indefinido	&	0x00000004 	\\
\hline
		Interrupção de Software (swi)	&	Supervisor	&	0x00000008	\\
\hline
		\emph{Prefetch abort}			&	\emph{Abort}		&	0x0000000C \\
\hline
		\emph{Data abort}				&	\emph{Abort}		&	0x00000010	\\
\hline
		Interrupção normal(IRQ)			&	IRQ			&	0x00000018 \\
\hline
		Interrupção rápida(FIQ)			&	FIQ			&	0x0000001C	\\
\hline
\end{tabular}
\caption{Vetor de interrupção \cite{ArchManual}}
\label{table:interrupt_vector}
\end{center}
\end {table}


Deve-se notar olhando para a tabela \ref{table:interrupt_vector}, que existe espaço suficiente para apenas uma instrução entre cada vetor de interrupção (4 bytes). Estes são inicializados com instruções de desvio (\emph{branch}).


\subsubsection{Prioridade das Interrupções}

Quando várias interrupções acontecem ao mesmo tempo, uma prioridade fixa do sistema determina a ordem na qual elas serão manipuladas. Essa prioridade é listada na tabela \ref{table:prior_interrupt}:

\begin{table}[ht]
\begin{center}
\begin{tabular}{l l}
\hline\hline %inserts double horizontal lines
Prioridade & Interrupção \\
\hline % inserts single horizontal line
alta 	& Reset \\ % inserting body of the table
 		& \emph{Data abort} \\
 		& FIQ \\
 		& IRQ \\
 		& \emph{Prefetch abort} \\
baixa 	& Instrução indefinida e interrupção de software (swi) \\ 
\hline %inserts single line
\end{tabular}
\caption{Ordem de prioridade das interrupções \cite{TechManual}} 
\label{table:prior_interrupt}
\end{center}
\end{table}

\subsubsection{Entrada de interrupção}

Executar uma interrupção necessita que o processador preserve o estado atual: em geral, o conteúdo de todos os registradores (especialmente PC e CPSR) devem ser o mesmo depois de uma interrupção.

O processador ARM usa os registradores adicionais de cada modo para ajudar a salvar o estado do processador. Quando uma interrupção acontece, o R14 e o SPSR são usados para guardar o estado atual da seguinte maneira \cite{TechManual}:

\begin{enumerate}
\item Preserva o endereço da próxima instrução (PC+4 ou PC+8, depende da interrupção) no apropriado LR (R14). Isso permite ao programa continuar do lugar de onde parou no retorno da interrupção.
\item Copia o CPSR para o apropriado SPSR.
\item Força os bits de modo do CPSR para um valor que corresponde ao tipo de interrupção.
\item Força o PC buscar a próxima instrução no vetor de interrupção.
\end{enumerate}

O processador ARM7TDMI também pode ativar a \emph{flag} de interrupção desabilitada para prevenir próximas interrupções.

\begin{figure}[ht]
	\begin{center}
		\includegraphics[scale=0.10]{figuras/interrupt.png}
		\caption{Esquema de uma interrupção no ARM7TDMI \cite{Zaitseff2003}}
		\label{fig:interrupt}
	\end{center}
\end{figure}


\subsubsection{Saída de interrupção}

Quando uma interrupção é completada deve-se \cite{TechManual}:

\begin{enumerate}
\item Mover o LR (R14), menos um \emph{offset}, para o PC. O offset varia de acordo com o tipo de interrupção mostrada na figura anterior.
\item Copiar o SPSR de volta para o CPSR.
\item Limpar os \emph{flags} de interrupção desabilitada que foram ativados na entrada.
\end{enumerate} 


\subsubsection{Interrupções de software}

Uma interrupção de software é uma interrupção inicializada inteiramente por um programa para entrar no modo Supervisor e assim poder utilizar alguma rotina particular, como operações de entrada e saída do sistema \cite{Zaitseff2003}.

Quando uma interrupção de software é executada, as seguintes ações são realizadas \cite{ArchManual}:

\begin{enumerate}
\item Copia o endereço da próxima instrução no registrador LR\textunderscore svc (R14\textunderscore svc).

\begin{lstlisting}
R14_svc = endereço da próxima instrução
\end{lstlisting}

\item Copia o CPSR no SPSR\textunderscore svc.

\begin{lstlisting}
SPSR_svc = CPSR
\end{lstlisting}

\item Coloca os bits de modo do CPSR para o valor correspondente ao modo Supervisor.

\begin{lstlisting}
CPSR[4:0] = 0b10011 /* modo Supervisor */
\end{lstlisting}

\item Reforça o estado ARM colocando o bit T do CPSR à zero.

\begin{lstlisting}
CPSR[5] = 0 /* estado ARM */
\end{lstlisting}

\item Desabilita as interrupções normais colocando o bit I do CPSR a um. Interrupções FIQ não são desabilitadas e podem continuar ocorrendo.

\begin{lstlisting}
CPSR[7] = 1 /* desabilita interrupções normais */
\end{lstlisting}

\item Carrega o endereço do vetor de interrupções, 0x00000008, no PC.

\begin{lstlisting}
PC = 0x00000008
\end{lstlisting}

\end{enumerate}

Para retornar da operação de interrupção, é usada a seguinte instrução para restaurar o PC (a partir do R14\textunderscore svc) e CPSR (a partir do SPSR\textunderscore svc):

\begin{lstlisting}
MOVS PC,LR
\end{lstlisting}


\subsubsection{Interrupções de hardware}

Interrupções de hardware são mecanismos que permitem que um sinal externo (pedido de interrupção) interrompa a execução normal do programa corrente e desvie a execução para um bloco de código chamado de rotina de interrupção \cite{Kinoshita}.

Interrupções são úteis, pois permitem que o processador manuseie periféricos de uma maneira mais eficiente. Sem interrupções o processador teria que verificar periodicamente a entrada/saída de um dispositivo para ver se esse necessita de atenção.  Com interrupções, por outro lado, a entrada/saída do dispositivo pode indicar diretamente a ocorrência de um dado evento externo, que será tratado com maior facilidade e rapidez, de modo que o microprocessador não necessite consumir tempo de processamento para pesquisar a ocorrência de eventos externos.

O processador ARM fornece dois sinais que são usados pelos periféricos para pedir uma interrupção: o sinal de interrupção nIRQ e o sinal de interrupção rápida nFIQ. Ambos são ativados em nível baixo, ou seja, colocando o sinal em nível baixo geramos a interrupção correspondente, se a interrupção não tiver sido desabilitada no CPSR \cite{Zaitseff2003}.

Quando uma interrupção de \emph{hardware} IRQ (ou FIQ) é detectada, as seguintes ações são realizadas \cite{ArchManual}:

\begin{enumerate}
\item Copia o endereço da próxima instrução à ser executada + 4 no registrador LR\textunderscore irq(R14\textunderscore irq). Isso significa que o LR\textunderscore irq irá apontar para a segunda instrução à partir do ponto de pedido da interrupção.

\begin{lstlisting}
R14_irq = endereço da próxima instrução + 4
\end{lstlisting}

\item Copia o CPSR no SPSR\textunderscore irq.

\begin{lstlisting}
SPSR_irq = CPSR
\end{lstlisting}

\item Coloca os bits de modo do CPSR para o valor correspondente ao modo IRQ.

\begin{lstlisting}
CPSR[4:0] = 0b10010 /* modo IRQ */
\end{lstlisting}

\item Reforça o estado ARM colocando o bit T do CPSR à zero.

\begin{lstlisting}
CPSR[5] = 0 /* estado ARM */
\end{lstlisting}

\item Desabilita as interrupções normais colocando o bit I do CPSR a um. Interrupções FIQ não são desabilitadas e podem continuar ocorrendo.

\begin{lstlisting}
CPSR[7] = 1 /* desabilita interrupções normais */
\end{lstlisting}

\item Carrega o endereço do vetor de interrupções, 0x00000008, no PC.

\begin{lstlisting}
PC = 0x00000018
\end{lstlisting}

\end{enumerate}

Assim que a rotina de interrupção é terminada, o processador retorna ao que estava fazendo antes através das seguintes ações:

\begin{enumerate}
\item Move o conteúdo do registrador LR\textunderscore irq menos 4 para o PC.
\item Copia SPSR\textunderscore irq de volta para CPSR.
\end{enumerate}

A seguinte instrução executa os passos mostrados a cima:

\begin{lstlisting}
SUBS PC, R14,#4
\end{lstlisting}

Note que a instrução é SUBS, e não SUB: a instrução SUBS copia automaticamente SPSR no CPSR, mas apenas quando o registrador de destino é o PC (R15) e a instrução é executada em um modo privilegiado.

O processamento das \emph{Fast Interrupt} (FIQ) é praticamente igual ao de uma interrupção normal (IRQ). As diferenças são que um conjunto diferente de registradores é usado (i.e. R14\textunderscore fiq no lugar de R14\textunderscore irq), que tanto as interrupções IRQ quanto as FIQ são desativadas (ou seja, os bits I e F do CPSR são ativados), e que o endereço do vetor de interrupção é 0x0000001C \cite{Zaitseff2003}.

\paragraph{}