% O Processador ARM7
\section{O Processador ARM7TDMI} \label{sec:conceitos_processador}
\index{conceitos!processador} 

O ARM7TDMI faz parte da família de processadores ARM7 32 bits conhecida por oferecer bom desempenho aliado a um baixo consumo de energia. Essas características fazem com que o ARM7TDMI seja bastante utilizado em media players, vídeo games e, principalmente, em sistemas embarcados e num grande número de aparelhos celulares.

%-------------------------------------------
% Arquitetura RISC
%-------------------------------------------
\subsection{Arquitetura RISC} \label{sub:risc}
\index{conceitos!processador!risc}

Os processadores ARM, incluindo o ARM7TDMI, foram projetados com a arquitetura RISC.

RISC (Reduced Instruction Set Computer) é uma arquitetura de computadores baseada em um conjunto simples e pequeno de instruções capazes de serem executadas em um único ou poucos ciclos de relógio.
 
A idéia por trás da arquitetura RISC é de reduzir a complexidade das instruções executadas pelo hardware e deixar as tarefas mais complexas para o software. Como resultado, o RISC demanda mais do compilador do que os tradicionais computadores CISC (Complex Instruction Set Computer) que, por sua vez, dependem mais do processador já que suas instruções são mais complicadas.

As principais características da arquitetura RISC são:

\begin{enumerate}

\item Conjunto reduzido e simples de instruções capazes de serem executadas em único ciclo de máquina.

\item Uso de pipeline, ou seja, o processamento das instruções é quebrado em pequenas unidades que podem ser executadas em paralelo.

\item Presença de um conjunto de registradores.

\item Arquitetura Load-Store: o processador opera somente sobre os dados contidos nos registradores e instruções de load/store transferem dados entre a memória e os registradores.

\item Modos simples de endereçamento à memória.

\end{enumerate}

%-------------------------------------------
% Pipeline
%-------------------------------------------
\subsection{Pipeline} \label{sub:pipeline}
\index{conceitos!processador!pipeline}

A arquitetura de pipeline aumenta a velocidade do fluxo de instruções para o processador, pois permite que várias operações ocorram simultaneamente, fazendo o processador e a memória operarem continuamente. 

O ARM7 possui uma arquitetura de pipeline de três estágios. Durante operação normal, o processador estará sempre ocupado em executar três instruções em diferentes estágios. Enquanto executa a primeira, decodifica a segunda e busca a terceira.

\begin{figure}[htb]
	\begin{center}
		\includegraphics[scale=0.25]{figuras/pipeline.pdf}
		\caption{Pipeline de 3 estágios\label{fig:pipeline}}
	\end{center}
\end{figure}

O primeiro estágio de pipeline lê a instrução da memória e incrementa o valor do registrador de endereços, que guarda o valor da próxima instrução a ser buscada. O próximo estágio decodifica a instrução e prepara os sinais de controle necessários para executá-la.  O terceiro lê os operandos do banco de registradores, executa as operações através da ALU (Arithmetic Logic Unit), lê ou escreve na memória, se necessário, e guarda o resultado das instruções no banco de registradores.

\begin{figure}[htb]
	\begin{center}
		\includegraphics{figuras/pipeline2.jpg}
		\caption{Pipeline do ARM7TDMI\label{fig:pipeline2}}
	\end{center}
\end{figure}


Algumas características importantes do pipeline do ARM7:

\begin{itemize}

\item O Program Counter (PC) ao invés de apontar para a instrução que esta sendo executada, aponta para a instrução que esta sendo buscada na memória.

\item O processador só processa a instrução quando essa passa completamente pelo estágio execute. Ou seja, somente quando a quarta instrução é buscada (fetched).

\item A execução de uma instrução de branch através da modificação do PC provoca a descarga de todas as outras instruções do pipeline.

\item Uma instrução no estágio execute será completada mesmo se acontecer uma interrupção. As outras instruções no pipeline serão abandonadas e o processador começará a encher o pipeline a partir da entrada apropriada no vetor de interrupção.

\end{itemize}



%-------------------------------------------
% Estados de Operação
%-------------------------------------------
\subsection{Estados de Operação} \label{sub:estados}
\index{conceitos!processador!estados}

O processador ARM7TDMI possui dois estados de operação:

\begin{itemize}
\item ARM: modo normal, onde o processador executa instruções de 32 bits (cada instrução corresponde a uma palavra);
\item Thumb: modo especial, onde o processador executa instruções de 16 bits que correspondem à meia palavra.
\end{itemize}

Instruções Thumbs são um conjunto de instruções de 16 bits equivalentes as instruções 32 bits ARM. A vantagem em tal esquema, é que a densidade de código aumenta, já que o espaço necessário para um mesmo número de instruções é menor. Em compensação, nem todas as instruções ARM tem um equivalente Thumb.

Neste projeto, decidimos pela utilização do processador no modo ARM que facilita o desenvolvimento por possuir um número maior de instruções.


%-------------------------------------------
% Modos de Operação
%-------------------------------------------
\subsection{Modos de Operação} \label{sub:modo}
\index{conceitos!processador!modos}

Os processadores ARM possuem 7 modos de operação:

\begin{center}
\begin{tabular}{|l|l|p{7.5cm}|}
\hline
		\textbf{Modo}	&	\textbf{Identificador}	& \textbf{Descrição}	\\
\hline
		Usuário			&	usr			& 	Execução normal de programas.	\\
\hline
		FIQ(Fast Interrupt)	&	fiq		&	Tratamento de interrupções rápidas. \\
\hline
		IRQ (Interrupt)	&	irq			&	Tratamento de interrupções comuns.	\\
\hline
		Supervisor		&	svc			&	Modo protegido para o sistema operacional.	\\
\hline
		Abort			&	abt			&	Usado para implementar memória virtual ou manipular violações na memória.	\\
\hline
		Sistema			&	sys			&	Executa rotinas privilegiadas do sistema operacional.	\\
\hline
		Indefinido		&	und			&	Modo usado quando uma instrução desconhecida é executada.	\\
\hline
\end{tabular}
\end{center}

Mudanças no modo de operação podem ser feitas através de programas, ou podem ser causadas por interrupções externas ou exceções (interrupções de software).

A maioria dos programas roda no modo Usuário. Quando o processador esta no modo Usuário, o programa que esta sendo executado não pode acessar alguns recursos protegidos do sistema ou mudar de modo sem ser através de uma interrupção.

Os outros modos são conhecidos como modos privilegiados. Eles têm total acesso aos recursos do sistema e podem mudar livremente de modo de operação. Cinco desses modos são conhecidos como modos de interrupção: FIQ, IRQ, Supervisor, Abort e Indefinido.

Entra-se nesses modos quando uma interrupção ocorre. Cada um deles possui registradores adicionais que permitem salvar o modo Usuário quando uma interrupção ocorre.

O modo remanescente é o modo Sistema, que não é acessível por interrupção e usa os mesmos registradores disponíveis para o modo Usuário. No entanto, este é um modo privilegiado e, assim, não possui as restrições do modo Usuário.  Este modo destina-se as operações que necessitam de acesso aos recursos do sistema, mas que querem evitar o uso adicional dos registradores associados aos modos de interrupção.



%-------------------------------------------
% Registradores
%-------------------------------------------
\subsection{Registradores} \label{sub:registradores}
\index{conceitos!processador!registradores}

O processador ARM7TDMI tem um total de 37 registradores:

\begin{itemize}
\item 31 registradores de 32 bits de uso geral
\item 6 registradores de estado
\end{itemize}

Esses registradores não são todos acessíveis ao mesmo tempo. O modo de operação do processador determina quais registradores são disponíveis ao programador.




%-------------------------------------------
% Registradores de Estado
%-------------------------------------------
\subsection{Registradores de Estado} \label{sub:reg_estado}
\index{conceitos!processador!reg_estado}




%-------------------------------------------
% Interrupções
%-------------------------------------------
\subsection{Interrupções} \label{sub:interrupcoes}
\index{conceitos!processador!interrupcoes}


